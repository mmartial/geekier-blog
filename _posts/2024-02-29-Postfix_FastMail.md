---
title: "Postfix using FastMail setup"
date: 2024-02-29
tags:
- Linux
- Guide
- Ubuntu22
- Fastmail
- Postfix
show_downloads: [false]
---

Set up instructions for using Postfix as a Send-Only SMTP server, using Fastmail.com, on a Ubuntu Linux 22.04 server.

<h1>Postfix using Fastmail.com</h1>

Revision: 20240229-0

- [1. Preamble](#1-preamble)
  - [1.1. How to use this guide](#11-how-to-use-this-guide)
  - [1.2. Fastmail](#12-fastmail)
  - [1.3. Postfix](#13-postfix)
- [2. Setup](#2-setup)
  - [2.1. Fastmail email setup](#21-fastmail-email-setup)
  - [2.2. Postfix setup](#22-postfix-setup)
    - [2.2.1. mailutils](#221-mailutils)
    - [2.2.2. Email Headers](#222-email-headers)
    - [2.2.3. Credentials](#223-credentials)
    - [2.2.4. Postfix main configuration](#224-postfix-main-configuration)
- [3. Revision History](#3-revision-history)
  - [3.1. Contribute](#31-contribute)

Instructions for a Linux host running Ubuntu 22.04 server to have a means to send emails using Postfix sending through Fastmail.

# 1. Preamble

## 1.1. How to use this guide

Our recommendation is to grab the source for this document from GitHub. Look at the post date, and in the repo, find it as `_posts/YYYY-MM-DD-Title.md`.
Once you have obtained the source markdown file, open it in an editor and perform a find and replace for the different values that you will need to customize for your setup. This will allow you to copy/paste directly from the source file.

Values to adjust (in order of easier replacement):
- **`push@example.com`**, the email address set up in FastMail to send emails from.
- **`host.example.com`**, the DNS name of your server (pointing to an unroutable private IP is fine)
- **`example@fastmail.com`** is the account owner of the FastMail account.
- **`example.com`**, the domain we send emails from.
- **`test@gmail.com`**, the destination email we will test sending to.

## 1.2. Fastmail

We will rely on [fastmail.com](https://www.fastmail.com/) to send emails.
FastMail is an email service provider with a focus on speed, privacy, and secure email communication. **It is a paid email service** for individuals and businesses, supporting standard email protocols such as IMAP, SMTP, and CalDAV/CardDAV, making it compatible with a wide range of email clients and devices.
FastMail offers robust support for custom domains, allowing users to personalize their email addresses with their own domain names. Users can create email addresses that are linked to their domain, such as `username@example.com`.
More details on the above can be found at https://www.fastmail.help/hc/en-us/articles/360058753394-Custom-domains-with-Fastmail

Since setup differs we will not cover the steps detailed in the URL above and will expect that the domain's `MX` points to Fastmail and that `SPF` and `DKIM` are properly configured at your DNS. Fastmail has a useful dashboard on its `Domains` page with checkmarks for those settings.
Once properly configured, you will have "Your domain is correctly set up to send and receive mail!" on that domain's dashboard on Fastmail.

We will use them to send emails from a user from the `example.com` domain using their outgoing SMTP services using app-specific passwords through Postfix.

## 1.3. Postfix

[Postfix](https://www.postfix.org/) Postfix is a free and open-source mail transfer agent (MTA) that routes and delivers electronic mail. It is an alternative to the widely used Sendmail program and is designed with a focus on security, ease of use, and efficient handling of large volumes of email. Postfix's architecture is modular, which allows for flexibility and extensibility. It supports a variety of mail protocols, including SMTP, and is highly configurable, enabling administrators to tailor its behavior to suit specific requirements. Due to its performance, security features, and simplicity in configuration, Postfix has become a popular choice for both small and large-scale mail systems.

We will use a "send-only" SMTP setup using Postfix; to allow our server to send emails without the capability to receive incoming emails, which will allow us to send system notifications or any automated emails generated by scripts, applications, or monitoring tools. 

Digital Ocean has an excellent primer on using of postfix without Fastmail, see https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-postfix-as-a-send-only-smtp-server-on-ubuntu-22-04

# 2. Setup

## 2.1. Fastmail email setup

Our Fastmail account is `example@fastmail.com`, we will need this information later for the relay to work.

We will use the `push@example.com` email alias for sending messages, and adapt the domain and the email address as needed.
Fastmail notes that "Every external program or app needs its own app password to access your information", more details at https://www.fastmail.help/hc/en-us/articles/360058752854-App-passwords
Fastmail "server name and ports" are detailed at https://www.fastmail.help/hc/en-us/articles/1500000278342-Server-names-and-ports and we will follow the instructions for SMTP on port 465.

From your Fastmail "Settings" dashboard, select `Set Up -> My email address` and `Add address` then `Create an Alias`. Add `push@example.com` and on the next page, decide what you want to do "when a message is delivered to this address" and add a "Description". You can also configure the "Advanced delivery preferences" and "Compose options" as per your needs.

From your Fastmail "Settings" dashboard, select `Stay Secure -> Privacy & Security`. In the `Integrations` tab, create a `New App Password`. `Name` it `postfix` and give it only `SMTP` access. Copy and store this "postfix smtp app password" in a password manager for future use, as "this is the password for your app. Spaces and capitals donʼt matter. For your security we wonʼt show this password again".

## 2.2. Postfix setup

Although unlikely to occur with the header fixes, we invite you to set up the server's `hostname` to be a Fully Qualified Domain Main ([FQDN](https://en.wikipedia.org/wiki/Fully_qualified_domain_name)).
To do so `sudo nano /etc/hostname` and replace the value by `host.example.com`. 
A reboot is recommended, but you can also `sudo hostname host.example.com` until the next reboot.

### 2.2.1. mailutils

Install the required tools (including `postfix`), adapting `example.com` to your domain.

```bash
sudo apt-get update

sudo apt-get install mailutils
# during this step, you will be prompted to select the mail configuration that best matches your needs, select "Internet Site"
# as per the following dialogue: if a mail address on the local host is foo@example.org, the correct value for this option would be example.org
# as such, give it example.com
```

If you made an entry error at this point, run `sudo dpkg-reconfigure postfix`.
We will manually modify the configuration next.

### 2.2.2. Email Headers

We need to create a couple of files we will require later so the headers of any emails relayed are sent from an authorized email on your FastMail account.

- `sudo nano /etc/postfix/header_check` and add the following

```bash
/From:.*/ REPLACE From: push@example.com
```

- `sudo /etc/postfix/sender_canonical_maps` and add the following

```bash
/.+/    push@example.com
```

### 2.2.3. Credentials

`sudo nano /etc/postfix/sasl/fastmail` with the below content, adapting the "postfix smtp app password" generated earlier. Note that we use the FastMail account itself, not the email alias we created:

```bash
[smtp.fastmail.com]:465 example@fastmail.com:apppassword
```

Make it only readable by the `root` user, using `sudo chmod 400 /etc/postfix/sasl/fastmail`

Tell `postfix` to use the credentials using its lookup table management utility to create a `/etc/postfix/sasl/fastmail.db` file:

```bash
sudo postmap /etc/postfix/sasl/fastmail
```

### 2.2.4. Postfix main configuration

`sudo nano /etc/postfix/main.cf` and:

- modify `myhostname` to have our domain information (the DNS entry does not need to exist, but an unroutable network/private IP in your DNS will also work):

```bash
myhostname = host.example.com
```

- empty the `mydestination` field so that all emails sent out are sent through the relay:

```bash
mydestination =
```

- find the `inet_interfaces` and make it `loopback-only` so that our `postfix` does not listen on any other active network interface:

```bash
inet_interfaces = loopback-only
```

- optionally, make it use IPv4 only by modifying `inet_protocols` 

```bash
inet_protocols = ipv4
```

- Comment the earlier `smtpd_tls_security_level` and  `relayhost` lines to avoid warnings, then add the following to the end of the file:

```bash
relayhost = [smtp.fastmail.com]:465
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl/fastmail
smtp_sasl_security_options = noanonymous
smtp_use_tls = yes
smtp_tls_wrappermode = yes
smtp_tls_security_level = encrypt
```
You can see the `/etc/postfix/sasl/fastmail` is referenced. 
Additional details on TLS for postfix can be found at https://www.postfix.org/TLS_README.html
Because we are not using port 587 (Fastmail recommends using port 465 for SMTP), we are using the `wrappermode`.

- Add the following lines to make use of the header modification files we created earlier

```bash
sender_canonical_classes = envelope_sender, header_sender
sender_canonical_maps =  regexp:/etc/postfix/sender_canonical_maps
smtp_header_checks = regexp:/etc/postfix/header_check
```

- Reload `postfix` with its new configuration
  
```bash
sudo /etc/init.d/postfix reload
```

- Test sending an email to `test@gmail.com`:

```bash
# content and subject
echo "Test mail content" | mail -s "Postfix Subject" test@gmail.com
```
You can check for errors using `tail -n 30 /var/log/syslog`.
If all went well you should have an entry with a `status=sent` value and looking similar to (`###`-ing variable content)
```log
postfix/smtp[###]: ###: to=<test@gmail.com>, relay=smtp.fastmail.com[###.###.###.###]:465, delay=###, delays=###/###/###/###, dsn=2.0.0, status=sent (250 2.0.0 Ok: queued as ### ### via ###)
```

The real confirmation is the reception of the email, sent by `push@example.com` at your `test@gmail.com` email.

# 3. Revision History

- 20240229-0: Intitial release.
 
## 3.1. Contribute

If you see a problem or simply want to contribute, this is a GitHub-based repo, feel free to send a PR.
